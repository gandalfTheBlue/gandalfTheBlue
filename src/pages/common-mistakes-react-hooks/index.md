---
title: 2020å¹´ç¼–å†™Reactç»„ä»¶(hooks)çš„äº”ä¸ªå¸¸è§é”™è¯¯
date: '2020-06-07'
---

åŸæ–‡é“¾æ¥: [Five common mistakes writing react components (with hooks) in 2020](https://www.lorenzweiss.de/common_mistakes_react_hooks/)

### `æœ¬æ–‡æ˜¯å…³äºæˆ‘å‘ç°çš„ç¼–å†™Reactç»„ä»¶æ—¶æœ€å¸¸è§çš„é”™è¯¯ï¼Œä¸ºä»€ä¹ˆå®ƒä»¬æ˜¯é”™è¯¯ä»¥åŠå¦‚ä½•é¿å…æˆ–ä¿®å¤å®ƒä»¬ã€‚`

![](./fish.jpg)

# ä½œä¸ºæ¡†æ¶çš„React

Reactå‡ºç°åœ¨åœ¨Webå¼€å‘é¢†åŸŸå·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œè¿‘å¹´æ¥å®ƒä½œä¸ºæ•æ·Webå¼€å‘å·¥å…·çš„åœ°ä½ç¨³æ­¥å¢å¼ºã€‚ ç‰¹åˆ«æ˜¯åœ¨å®£å¸ƒå¹¶å‘å¸ƒäº†æ–°çš„[hook API/æ¦‚å¿µ](https://reactjs.org/docs/hooks-state.html#hooks-and-function-components)ä¹‹åï¼Œç¼–å†™ç»„ä»¶ä»æœªå¦‚æ­¤ç®€å•ã€‚

å°½ç®¡ReactèƒŒåçš„å›¢é˜Ÿå’Œåºå¤§çš„ç¤¾åŒºåŠ›é‡è¯•å›¾ä»¥ä»¤äººå°è±¡æ·±åˆ»çš„æ–¹å¼åŸ¹è®­å’Œè§£é‡Šæ¡†æ¶çš„æ¦‚å¿µï¼Œä½†æˆ‘ä»ç„¶çœ‹åˆ°ä½¿ç”¨è¯¥æ¡†æ¶æ—¶é‡åˆ°çš„ä¸€äº›é™·é˜±å’Œå¸¸è§é”™è¯¯ã€‚ æˆ‘è®°å½•äº†è¿‡å»å‡ å¹´ä¸­æˆ‘çœ‹åˆ°çš„æ‰€æœ‰ä¸Reactç›¸å…³çš„é”™è¯¯ï¼Œå°¤å…¶æ˜¯React Hooksç›¸å…³çš„ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºæœ€å¸¸è§çš„é”™è¯¯ï¼Œå¹¶ä¸”è¿˜å°†å°è¯•è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆæˆ‘è®¤ä¸ºå®ƒä»¬æ˜¯é”™è¯¯ï¼Œå¹¶æå‡ºäº†ä»¥æ›´ç®€æ´çš„æ–¹å¼è¿›è¡Œç¼–ç çš„å»ºè®®ã€‚

## å…è´£å£°æ˜

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œæˆ‘å¿…é¡»è¯´æ˜ä¸‹é¢åˆ—å‡ºçš„å¤§å¤šæ•°äº‹æƒ…éƒ½ä¸æ˜¯æ ¹æœ¬æ€§çš„é”™è¯¯æˆ–è€…ä¹ä¸€çœ‹ç”šè‡³çœ‹ä¸å‡ºé”™è¯¯ï¼Œè€Œä¸”å¤§å¤šæ•°ä¹Ÿä¸å¤§å¯èƒ½å½±å“åº”ç”¨çš„æ€§èƒ½æˆ–å¤–è§‚ã€‚ é™¤äº†ä»äº‹è¯¥äº§å“çš„å¼€å‘äººå‘˜å¤–ï¼Œä¹Ÿè®¸æ²¡äººä¼šæ³¨æ„åˆ°è¿™é‡Œæœ‰äº›é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»ç„¶ç›¸ä¿¡ï¼Œé«˜è´¨é‡çš„ä»£ç å¯ä»¥å¸¦æ¥æ›´å¥½çš„å¼€å‘ä½“éªŒï¼Œä»è€Œå¸¦æ¥æ›´å¥½çš„äº§å“ã€‚

ä¸ä»»ä½•è½¯ä»¶æ¡†æ¶æˆ–åº“ä¸€æ ·ï¼Œå¯¹ä¸€ä¸ªé—®é¢˜æ€»æœ‰æ•°ç™¾ä¸‡ç§ä¸åŒçš„æ„è§ã€‚ æ‚¨åœ¨æ­¤å¤„çœ‹åˆ°çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯åŸºäºæˆ‘çš„ä¸ªäººè§‚ç‚¹ï¼Œä¸åº”è§†ä¸ºä¸€èˆ¬è§„åˆ™ã€‚ å¦‚æœæ‚¨å¯¹æ­¤æœ‰ä¸åŒçš„çœ‹æ³•ï¼Œæˆ‘æ´—è€³æ­å¬ã€‚ğŸŒŸ

# 1. åœ¨ä¸éœ€è¦é‡æ–°æ¸²æŸ“çš„åœ°æ–¹ä½¿ç”¨useState

Reactçš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€æ˜¯å¤„ç†çŠ¶æ€ã€‚ æ‚¨å¯ä»¥é€šè¿‡çŠ¶æ€æ§åˆ¶æ•´ä¸ªæ•°æ®æµå’Œæ¸²æŸ“ã€‚ æ¯æ¬¡é‡æ–°æ¸²æŸ“æ ‘æ—¶ï¼Œå®ƒå¾ˆå¯èƒ½ä¸çŠ¶æ€å˜åŒ–æœ‰å…³ã€‚

é€šè¿‡`useState hook`ï¼Œç°åœ¨å¯ä»¥åœ¨å‡½æ•°ç»„ä»¶ä¸­å®šä¹‰çŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ç§åœ¨Reactä¸­å¤„ç†çŠ¶æ€çš„éå¸¸æ•´æ´è€Œç®€ä¾¿çš„æ–¹æ³•ã€‚ ä½†æ­£å¦‚æˆ‘ä»¬åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œå®ƒä¹Ÿå¯èƒ½è¢«é”™è¯¯ä½¿ç”¨ã€‚

å¯¹äºä¸‹ä¸€ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›è¯´æ˜ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæŒ‰é’®ï¼Œä¸€ä¸ªæŒ‰é’®æ˜¯è®¡æ•°å™¨ï¼Œå¦ä¸€ä¸ªæŒ‰é’®ä½¿ç”¨å½“å‰è®¡æ•°å‘é€APIè¯·æ±‚æˆ–è§¦å‘æ“ä½œã€‚ ä¸è¿‡ï¼Œå½“å‰è®¡æ•°æ°¸è¿œä¸ä¼šåœ¨ç»„ä»¶å†…å±•ç¤ºã€‚ ä»…å½“å•å‡»ç¬¬äºŒä¸ªæŒ‰é’®æ—¶æ‰éœ€è¦è¯¥è®¡æ•°æ¥å‘é€APIè¯·æ±‚ã€‚

### è¿™å¾ˆå±é™© âŒ

```jsx
function ClickButton(props) {
  const [count, setCount] = useState(0);

  const onClickCount = () => {
    setCount((c) => c + 1);
  };

  const onClickRequest = () => {
    apiCall(count);
  };

  return (
    <div>
      <button onClick={onClickCount}>Counter</button>
      <button onClick={onClickRequest}>Submit</button>
    </div>
  );
}
```

### é—®é¢˜æ‰€åœ¨ âš¡

ä¹ä¸€çœ‹ï¼Œæ‚¨å¯èƒ½ä¼šé—®è¿™åˆ°åº•æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ ä¸æ­£æ˜¯è¿™æ ·ç»´æŠ¤çŠ¶æ€å—ï¼Ÿæ˜¯çš„æ‚¨æ˜¯å¯¹çš„ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥æ­£å¸¸åœ°è¿è¡Œå¹¶ä¸”å¯èƒ½æ°¸è¿œä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨Reactä¸­ï¼Œæ¯æ¬¡çŠ¶æ€æ›´æ”¹éƒ½ä¼šå¯¹è¯¥ç»„ä»¶åŠå…¶å­ç»„ä»¶è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚ä½†æ˜¯åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬ä»æœªåœ¨ç»„ä»¶æ¸²æŸ“ä¸­ä½¿ç”¨è¯¥çŠ¶æ€ï¼Œæ‰€ä»¥æ¯æ¬¡è®¾ç½®è®¡æ•°å™¨æ—¶éƒ½ä¼šå¯¼è‡´ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œè¿™å¯èƒ½ä¼šå½±å“æ€§èƒ½æˆ–äº§ç”Ÿæ„å¤–çš„å‰¯ä½œç”¨ã€‚

### è§£å†³åŠæ³• âœ…

å¦‚æœè¦åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªå˜é‡ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„æ¸²æŸ“ä¸­ä¿æŒè¯¥å˜é‡çš„å€¼ï¼ŒåŒæ—¶å˜é‡å€¼çš„æ”¹å˜åˆä¸ä¼šå¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œåˆ™å¯ä»¥ä½¿ç”¨`useRef hook`ã€‚ å®ƒå¯ä»¥ä¿æŒå˜é‡å€¼ï¼Œä½†ä¸ä¼šå¼ºåˆ¶é‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚
```jsx
function ClickButton(props) {
  const count = useRef(0);

  const onClickCount = () => {
    count.current++;
  };

  const onClickRequest = () => {
    apiCall(count.current);
  };

  return (
    <div>
      <button onClick={onClickCount}>Counter</button>
      <button onClick={onClickRequest}>Submit</button>
    </div>
  );
}
```

# 2. ä½¿ç”¨router.pushä»£æ›¿Link

è¿™å¯èƒ½æ˜¯ä¸€ä¸ªç®€å•ä»¥åŠéå¸¸å®¹æ˜“å‘ç°çš„é—®é¢˜å¹¶ä¸”å’ŒReactæœ¬èº«å¹¶æ²¡æœ‰çœŸæ­£çš„è”ç³»ï¼Œä½†æ˜¯å½“äººä»¬ç¼–å†™Reactç»„ä»¶æ—¶ï¼Œæˆ‘ä»ç„¶å¸¸å¸¸å‘ç°è¿™ç§å†™æ³•ã€‚

å‡è®¾åˆ›å»ºä¸€ä¸ªæŒ‰é’®ï¼Œå•å‡»è¯¥æŒ‰é’®ç”¨æˆ·å°†è¢«é‡å®šå‘åˆ°å¦ä¸€ä¸ªé¡µé¢ã€‚ ç”±äºåº”ç”¨æ˜¯SPAï¼Œæ‰€ä»¥è¯¥æ“ä½œå°†æ˜¯å®¢æˆ·ç«¯è·¯ç”±æœºåˆ¶ã€‚ å› æ­¤æˆ‘ä»¬å°†éœ€è¦æŸç§åº“æ¥æ‰§è¡Œå®¢æˆ·ç«¯è·¯ç”±æ“ä½œã€‚ åœ¨Reactç”Ÿæ€ä¸­ï¼Œæœ€å—æ¬¢è¿çš„æ˜¯è·¯ç”±åº“æ˜¯react-routerï¼Œä¸‹é¢çš„ç¤ºä¾‹å°†ä½¿ç”¨è¯¥åº“ã€‚

æ‰€ä»¥åªè¦æ·»åŠ ç‚¹å‡»äº‹ä»¶å›è°ƒå°±ä¼šå°†ç”¨æˆ·é‡å®šå‘åˆ°æ‰€éœ€çš„é¡µé¢ï¼Œå¯¹å—ï¼Ÿ

### è¿™å¾ˆå±é™© âŒ

```jsx
function ClickButton(props) {
  const history = useHistory();

  const onClick = () => {
    history.push('/next-page');
  };

  return <button onClick={onClick}>Go to next page</button>;
}
```

### é—®é¢˜æ‰€åœ¨ âš¡

å³ä½¿ä¸Šé¢çš„ä»£ç å¯¹äºå¤§å¤šæ•°ç”¨æˆ·æ¥è¯´éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†è¿™é‡Œçš„å¯è®¿é—®æ€§(accessibility)ä»ç„¶å­˜åœ¨å·¨å¤§çš„é—®é¢˜ã€‚ è¯¥æŒ‰é’®æ ¹æœ¬ä¸ä¼šè¢«æ ‡è®°ä¸ºåˆ°å¦ä¸€ä¸ªé¡µé¢çš„é“¾æ¥ï¼Œè¿™ä½¿å¾—å±å¹•é˜…è¯»å™¨å‡ ä¹æ— æ³•è¯†åˆ«è¯¥æŒ‰é’®ã€‚ å¦å¤–è¯•è¯•åœ¨æ–°æ ‡ç­¾é¡µæˆ–çª—å£ä¸­æ‰“å¼€è¿™ä¸ªé“¾æ¥ï¼Ÿ å¾ˆå¯èƒ½ä¸ä¼šæˆåŠŸã€‚

### è§£å†³åŠæ³• âœ…

ä¸ç”¨æˆ·äº¤äº’çš„è·³è½¬åˆ°å…¶ä»–é¡µé¢çš„ä»»ä½•é“¾æ¥åº”å°½å¯èƒ½ç”±`<Link>`ç»„ä»¶æˆ–å¸¸è§„çš„`<a>`æ ‡ç­¾å¤„ç†ã€‚

```jsx
function ClickButton(props) {
  return (
    <Link to="/next-page">
      <span>Go to next page</span>
    </Link>
  );
}
```

**é¢å¤–æ”¶è·:**  ä»£ç æ›´ç®€æ´ï¼Œæ›´å…·å¯è¯»æ€§ã€‚

# 3. ä½¿ç”¨useEffectå¤„ç†Actions

Reactå¼•å…¥çš„æœ€å¥½ï¼Œæ€è™‘æœ€å‘¨åˆ°çš„hookä¹‹ä¸€æ˜¯"useEffect" hookã€‚ å®ƒå¯ä»¥å¤„ç†ä¸`prop`æˆ–`state`å˜æ›´ç›¸å…³çš„actionsã€‚ useEffectéå¸¸æœ‰ç”¨ï¼Œä½†ä¹Ÿç»å¸¸åœ¨å¯èƒ½ä¸éœ€è¦å®ƒçš„åœ°æ–¹è¢«ä½¿ç”¨ã€‚

æƒ³è±¡æœ‰ä¸€ä¸ªç»„ä»¶ï¼Œè¯¥ç»„ä»¶ä¼šè¯·æ±‚å•†å“åˆ—è¡¨å¹¶å°†å…¶æ¸²æŸ“åˆ°domã€‚ å¦å¤–ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸï¼Œå°†è°ƒç”¨"onSuccess"å‡½æ•°ã€‚è¯¥å‡½æ•°ä½œä¸º`prop`ä¼ é€’ç»™äº†è¯¥ç»„ä»¶ã€‚

### è¿™å¾ˆå±é™© âŒ

```jsx
function DataList({ onSuccess }) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [data, setData] = useState(null);

  const fetchData = useCallback(() => {
    setLoading(true);
    callApi()
      .then((res) => setData(res))
      .catch((err) => setError(err))
      .finally(() => setLoading(false));
  }, []);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  useEffect(() => {
    if (!loading && !error && data) {
      onSuccess();
    }
  }, [loading, error, data, onSuccess]);

  return <div>Data: {data}</div>;
}
```

### é—®é¢˜æ‰€åœ¨ âš¡

ç»„ä»¶ä¸€å…±æœ‰ä¸¤ä¸ªuseEffect hookï¼Œç¬¬ä¸€ä¸ªåœ¨åˆæ¬¡æ¸²æŸ“æ—¶å¤„ç†apiè°ƒç”¨ï¼Œç¬¬äºŒä¸ªåœ¨loadingç»“æŸï¼Œæ²¡æœ‰é”™è¯¯å¹¶ä¸”çŠ¶æ€ä¸­æœ‰æ•°æ®çš„æƒ…å†µä¸‹è°ƒç”¨onSuccesså‡½æ•°ã€‚è¿™ä¸€å®šæ˜¯ä¸€æ¬¡æˆåŠŸçš„è°ƒç”¨ã€‚ çœ‹èµ·æ¥å¾ˆæœ‰é“ç†å§ï¼Ÿ

å¯ä»¥è‚¯å®šçš„æ˜¯å¯¹äºç¬¬ä¸€æ¬¡è°ƒç”¨è¿™æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¹¶ä¸”å¯èƒ½æ°¸è¿œä¸ä¼šå¤±è´¥ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¤±å»äº†actionå’Œéœ€è¦è¢«è°ƒç”¨çš„å‡½æ•°ä¹‹é—´çš„ç›´æ¥è”ç³»ã€‚ å¦å¤–æˆ‘ä»¬ä¸èƒ½100%ä¿è¯åœ¨fetchæ“ä½œæˆåŠŸåè¿™ç§æƒ…å†µæ‰ä¼šå‘ç”Ÿï¼Œè€Œè¿™æ­£æ˜¯æˆ‘ä»¬å¼€å‘äººå‘˜æ‰€è®¨åŒçš„ã€‚

### è§£å†³åŠæ³• âœ…

ä¸€ä¸ªç›´æ¥çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†"onSuccess"å‡½æ•°çš„è°ƒç”¨è®¾åœ¨fetchæˆåŠŸåçš„ä½ç½®ï¼š

```jsx
function DataList({ onSuccess }) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [data, setData] = useState(null);

  const fetchData = useCallback(() => {
    setLoading(true);
    callApi()
      .then((fetchedData) => {
        setData(fetchedData);
        onSuccess();
      })
      .catch((err) => setError(err))
      .finally(() => setLoading(false));
  }, [onSuccess]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  return <div>{data}</div>;
}
```

ç°åœ¨ä½•æ—¶è°ƒç”¨äº†onSuccessä¸€ç›®äº†ç„¶ï¼Œç¡®åˆ‡åœ°è¯´æ˜¯åœ¨apiè°ƒç”¨æˆåŠŸçš„æƒ…å†µä¸‹ã€‚